<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chomp Pro - 7x7 Optimized</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            background-color: #f5f0e6; margin: 0; padding: 20px 10px;
            touch-action: manipulation;
        }
        h1 { color: #5d4037; font-size: 1.8rem; margin-bottom: 15px; }
        #menu, #game-area { 
            background: white; padding: 25px; border-radius: 15px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1); text-align: center;
            width: 100%; max-width: 500px; box-sizing: border-box;
        }
        .setting-group label { display: block; font-size: 1.2rem; font-weight: bold; color: #5d4037; margin-bottom: 10px; }
        input[type="number"] { width: 70px; height: 45px; font-size: 1.3rem; border: 2px solid #8d6e63; border-radius: 8px; text-align: center; }
        #status { margin: 15px 0; font-size: 1.3rem; font-weight: bold; color: #d32f2f; min-height: 1.5em; }
        #grid-container {
            display: inline-block; background-color: #3e2723; padding: 10px; 
            border-radius: 8px; margin-bottom: 15px; max-width: 100%; overflow-x: auto;
        }
        #grid { display: grid; gap: 4px; margin: 0 auto; }
        .cell { 
            width: 45px; height: 45px; background-color: #8d6e63; border-radius: 4px; 
            transition: opacity 0.2s; -webkit-tap-highlight-color: transparent;
        }
        .cell.eaten { opacity: 0; pointer-events: none; }
        .cell.poison { background-color: #d32f2f; position: relative; }
        .cell.poison::after { content: "‚ò†Ô∏è"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; }
        button { 
            width: 100%; padding: 14px; font-size: 1.1rem; font-weight: bold;
            background-color: #5d4037; color: white; border: none; border-radius: 10px; 
            cursor: pointer; margin: 6px 0;
        }
        button:active { transform: scale(0.98); }
        .btn-undo { background-color: #f4a460; color: #5d4037; }
        .btn-secondary { background-color: #8d6e63; }
        .hidden { display: none; }
        @media (max-width: 450px) { .cell { width: 38px; height: 38px; } }
    </style>
</head>
<body>
    <h1>Chomp Pro (7x7 Opt)</h1>
    <div id="menu">
        <div class="setting-group">
            <label>üç´ Í≤åÏûÑÌåê ÌÅ¨Í∏∞ (ÏµúÎåÄ 7x7)</label>
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <input type="number" id="rows" value="7" min="2" max="7">
                <span style="font-size: 1.2rem;">X</span>
                <input type="number" id="cols" value="7" min="2" max="7">
            </div>
        </div>
        <button onclick="setupGame('PVP')">ÏÇ¨Îûå vs ÏÇ¨Îûå</button>
        <button onclick="setupGame('PVC')">Ïª¥Ìì®ÌÑ∞ÏôÄ ÎåÄÍ≤∞</button>
    </div>

    <div id="game-area" class="hidden">
        <div id="status"></div>
        <div id="grid-container"><div id="grid"></div></div>
        <button id="undo-btn" class="btn-undo" onclick="undoMove()">‚Ü© Ïã§Ìñâ Ï∑®ÏÜå</button>
        <button onclick="backToMenu()" class="btn-secondary">Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
    </div>

    <script>
        let ROWS, COLS, currentPlayer, gameOver, gameMode;
        let memo = new Map(); 
        let history = [];

        function setupGame(mode) {
            ROWS = Math.min(parseInt(document.getElementById('rows').value), 7);
            COLS = Math.min(parseInt(document.getElementById('cols').value), 7);
            gameMode = mode; currentPlayer = 1; gameOver = false; history = []; memo.clear();
            
            const cellSize = (window.innerWidth < 450) ? 38 : 45;
            const grid = document.getElementById('grid');
            grid.style.gridTemplateColumns = `repeat(${COLS}, ${cellSize}px)`;
            grid.style.width = `${COLS * cellSize + (COLS-1) * 4}px`;
            
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('status').innerText = "ÎãπÏã†Ïùò Ï∞®Î°ÄÏûÖÎãàÎã§!";
            createBoard();
            updateUndoButton();
        }

        function createBoard() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell' + (r === ROWS - 1 && c === 0 ? ' poison' : '');
                    cell.dataset.row = r; cell.dataset.col = c;
                    cell.onclick = () => handleChomp(r, c);
                    grid.appendChild(cell);
                }
            }
        }

        function handleChomp(r, c) {
            if (gameOver || (gameMode === 'PVC' && currentPlayer === 2)) return;
            if (document.querySelector(`[data-row="${r}"][data-col="${c}"]`).classList.contains('eaten')) return;
            saveHistory();
            processMove(r, c);
            if (!gameOver && gameMode === 'PVC') {
                document.getElementById('status').innerText = "AI Í≥ÑÏÇ∞ Ï§ë...";
                setTimeout(proComputerTurn, 300);
            }
        }

        function processMove(row, col) {
            document.querySelectorAll('.cell').forEach(cell => {
                if (parseInt(cell.dataset.row) <= row && parseInt(cell.dataset.col) >= col) cell.classList.add('eaten');
            });
            if (row === ROWS - 1 && col === 0) {
                document.getElementById('status').innerText = (currentPlayer === 1 ? "ÎãπÏã†" : "Ïª¥Ìì®ÌÑ∞") + " Ìå®Î∞∞! üíÄ";
                gameOver = true;
            } else {
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                document.getElementById('status').innerText = (currentPlayer === 1 ? "ÎãπÏã†" : "Ïª¥Ìì®ÌÑ∞") + "Ïùò Ï∞®Î°Ä";
            }
            updateUndoButton();
        }

        function saveHistory() {
            history.push({
                eaten: Array.from(document.querySelectorAll('.cell')).map(c => c.classList.contains('eaten')),
                currentPlayer: currentPlayer
            });
        }

        function undoMove() {
            if (history.length === 0 || gameOver) return;
            let last = history.pop();
            const cells = document.querySelectorAll('.cell');
            last.eaten.forEach((e, i) => e ? cells[i].classList.add('eaten') : cells[i].classList.remove('eaten'));
            currentPlayer = last.currentPlayer;
            document.getElementById('status').innerText = (currentPlayer === 1 ? "ÎãπÏã†" : "Ïª¥Ìì®ÌÑ∞") + "Ïùò Ï∞®Î°Ä";
            updateUndoButton();
        }

        function updateUndoButton() { document.getElementById('undo-btn').disabled = history.length === 0 || gameOver; }

        function getHeights() {
            let h = new Array(COLS).fill(0);
            for (let c = 0; c < COLS; c++) {
                for (let r = 0; r < ROWS; r++) {
                    if (!document.querySelector(`[data-row="${r}"][data-col="${c}"]`).classList.contains('eaten')) {
                        h[c] = ROWS - r; break;
                    }
                }
            }
            return h;
        }

        function solve(heights) {
            const key = heights.join(',');
            if (key === "1" + ",0".repeat(COLS-1)) return null;
            if (memo.has(key)) return memo.get(key);

            for (let c = 0; c < COLS; c++) {
                for (let h = 1; h <= heights[c]; h++) {
                    if (c === 0 && h === 1) continue;
                    let next = [...heights];
                    for (let i = c; i < COLS; i++) next[i] = Math.min(next[i], h - 1);
                    if (!solve(next)) {
                        const move = {r: ROWS - h, c: c};
                        memo.set(key, move); return move;
                    }
                }
            }
            memo.set(key, null); return null;
        }

        function proComputerTurn() {
            const move = solve(getHeights());
            if (move) processMove(move.r, move.c);
            else { // Ïßà ÏÉÅÌô©Ïù¥Î©¥ ÎûúÎç§
                let av = [];
                document.querySelectorAll('.cell:not(.eaten)').forEach(c => {
                    if (c.dataset.row != ROWS-1 || c.dataset.col != 0) av.push({r: +c.dataset.row, c: +c.dataset.col});
                });
                let sel = av.length ? av[Math.floor(Math.random()*av.length)] : {r: ROWS-1, c: 0};
                processMove(sel.r, sel.c);
            }
        }
        function backToMenu() { document.getElementById('menu').classList.remove('hidden'); document.getElementById('game-area').classList.add('hidden'); }
    </script>
</body>
</html>
