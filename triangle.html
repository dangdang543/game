<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>매트리킹: 삼각형 마스터</title>
    <style>
        body { 
            font-family: 'Malgun Gothic', sans-serif; 
            text-align: center; 
            background-color: #f4f7f6; 
            margin: 0; 
            padding: 10px;
            /* 모바일 클릭 시 파란색 하이라이트 제거 */
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: none; /* 브라우저 기본 제스처 방지 */
        }
        h1 { font-size: 1.5rem; margin: 10px 0; }
        #game-info { 
            margin-bottom: 15px; padding: 12px; background: white; 
            border-radius: 12px; display: block; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-width: 500px; margin-left: auto; margin-right: auto;
        }
        .score-board { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .p1 { color: #e74c3c; } .p2 { color: #3498db; }
        
        .canvas-container {
            width: 100%; max-width: 500px; margin: 0 auto; aspect-ratio: 1 / 1;
        }
        canvas { 
            background: white; border: 3px solid #2c3e50; border-radius: 10px; 
            cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            width: 100% !important; height: auto !important;
            display: block; /* 캔버스 하단 여백 제거 */
        }

        #msg { height: auto; min-height: 40px; margin-top: 10px; font-size: 1rem; font-weight: bold; color: #2c3e50; padding: 0 10px; }
        
        .controls { 
            margin-top: 15px; display: flex; justify-content: center; 
            gap: 8px; align-items: center; flex-wrap: wrap; 
            max-width: 500px; margin-left: auto; margin-right: auto;
        }
        .control-group { 
            background: #fff; padding: 8px 12px; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem;
        }
        input, select { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        button { 
            padding: 10px 15px; font-size: 0.9rem; cursor: pointer; 
            background: #2c3e50; color: white; border: none; border-radius: 6px; flex-grow: 1;
        }
        .reset-btn { background: #7f8c8d; }
    </style>
</head>
<body>
    <h1>삼각형 만들기</h1>
    
    <div id="game-info">
        <div class="score-board">
            <span class="p1">P1: <span id="p1-score">0</span></span> &nbsp;|&nbsp; 
            <span class="p2">P2: <span id="p2-score">0</span></span>
        </div>
        <div id="turn-display" style="font-weight: bold; color: #e74c3c;">플레이어 1 차례</div>
        <div id="msg">목표 삼각형을 선택하고 점을 찍으세요!</div>
    </div>

    <div class="canvas-container">
        <canvas id="gameCanvas" width="500" height="500"></canvas>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>격자:</label>
            <input type="number" id="gridInput" value="6" min="3" max="12" style="width: 35px;">
        </div>
        <div class="control-group">
            <label>목표:</label>
            <select id="targetTriangle">
                <option value="acute">예각</option>
                <option value="right" selected>직각</option>
                <option value="obtuse">둔각</option>
            </select>
        </div>
        <button onclick="changeSettings()">적용</button>
        <button class="reset-btn" onclick="resetGame()">리셋</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let GRID_SIZE = 6, TARGET_TYPE = 'right', PADDING = 50, SPACING;
        let selectedPoints = [], usedPoints = [], currentPlayer = 1, scores = { 1: 0, 2: 0 };

        function initDimensions() { 
            SPACING = (canvas.width - PADDING * 2) / (GRID_SIZE - 1); 
            requestAnimationFrame(draw);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    const x = PADDING + i * SPACING, y = PADDING + j * SPACING;
                    const used = usedPoints.find(p => p.i === i && p.j === j);
                    const sel = selectedPoints.some(p => p.i === i && p.j === j);
                    
                    ctx.beginPath();
                    ctx.arc(x, y, used ? 12 : (sel ? 10 : 6), 0, Math.PI * 2);
                    ctx.fillStyle = used ? (used.player === 1 ? "#e74c3c" : "#3498db") : (sel ? "#2ecc71" : "#ccc");
                    ctx.fill();
                    ctx.closePath();
                }
            }
        }

        function handleInput(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const mouseX = (clientX - rect.left) * scaleX;
            const mouseY = (clientY - rect.top) * scaleY;

            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    const x = PADDING + i * SPACING, y = PADDING + j * SPACING;
                    if (Math.hypot(x - mouseX, y - mouseY) < 28) { // 판정 범위 살짝 확대
                        if (usedPoints.some(p => p.i === i && p.j === j)) return;
                        const idx = selectedPoints.findIndex(p => p.i === i && p.j === j);
                        if (idx > -1) selectedPoints.splice(idx, 1);
                        else if (selectedPoints.length < 3) selectedPoints.push({i, j});
                        
                        if (selectedPoints.length === 3) validateTriangle();
                        requestAnimationFrame(draw);
                        return;
                    }
                }
            }
        }

        // 터치 시작 시 깜빡임 방지를 위해 mousedown 대신 touchstart만 사용하거나 분리
        canvas.addEventListener('touchstart', handleInput, { passive: false });
        canvas.addEventListener('mousedown', handleInput);

        function validateTriangle() {
            const [p1, p2, p3] = selectedPoints;
            const d12 = Math.pow(p1.i - p2.i, 2) + Math.pow(p1.j - p2.j, 2);
            const d23 = Math.pow(p2.i - p3.i, 2) + Math.pow(p2.j - p3.j, 2);
            const d31 = Math.pow(p3.i - p1.i, 2) + Math.pow(p3.j - p1.j, 2);
            
            const sides = [d12, d23, d31].sort((a, b) => a - b);
            const a2 = sides[0], b2 = sides[1], c2 = sides[2];
            const crossProduct = Math.abs((p2.i - p1.i) * (p3.j - p1.j) - (p2.j - p1.j) * (p3.i - p1.i));

            if (crossProduct === 0) {
                document.getElementById('msg').innerText = "일직선입니다! 다시 시도하세요.";
                selectedPoints = []; return;
            }

            let type = (a2 + b2 === c2) ? "right" : (a2 + b2 > c2 ? "acute" : "obtuse");
            const names = { acute: "예각", right: "직각", obtuse: "둔각" };
            
            if (type === TARGET_TYPE) {
                scores[currentPlayer]++;
                document.getElementById('msg').innerText = `성공! ${names[type]}삼각형.`;
                selectedPoints.forEach(p => usedPoints.push({i: p.i, j: p.j, player: currentPlayer}));
                currentPlayer = currentPlayer === 1 ? 2 : 1; 
                updateUI();
            } else {
                document.getElementById('msg').innerText = `땡! ${names[type]}삼각형입니다.`;
            }
            selectedPoints = [];
        }

        function updateUI() {
            document.getElementById('p1-score').innerText = scores[1];
            document.getElementById('p2-score').innerText = scores[2];
            const turnEl = document.getElementById('turn-display');
            turnEl.innerText = `플레이어 ${currentPlayer} 차례`;
            turnEl.style.color = currentPlayer === 1 ? '#e74c3c' : '#3498db';
        }

        function changeSettings() {
            GRID_SIZE = parseInt(document.getElementById('gridInput').value);
            TARGET_TYPE = document.getElementById('targetTriangle').value;
            resetGame();
        }

        function resetGame() {
            initDimensions(); selectedPoints = []; usedPoints = []; scores = { 1: 0, 2: 0 }; currentPlayer = 1;
            const names = { acute: "예각", right: "직각", obtuse: "둔각" };
            document.getElementById('msg').innerText = `${names[TARGET_TYPE]}삼각형을 만드세요!`;
            updateUI(); 
            requestAnimationFrame(draw);
        }

        window.addEventListener('resize', initDimensions);
        initDimensions();
    </script>
</body>
</html>
